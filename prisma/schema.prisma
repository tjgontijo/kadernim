generator client {
  provider = "prisma-client-js"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  user
  subscriber
  editor
  manager
  admin
}

model EducationLevel {
  id    String @id @default(cuid())
  name  String @unique
  slug  String @unique
  order Int    @default(0)

  grades            Grade[]
  resources         Resource[]
  communityRequests CommunityRequest[]
  bnccSkills        BnccSkill[]

  @@map("education_level")
}

model Grade {
  id    String @id @default(cuid())
  name  String
  slug  String @unique
  order Int    @default(0)

  educationLevelId String
  educationLevel   EducationLevel @relation(fields: [educationLevelId], references: [id])

  subjects          GradeSubject[]
  resources         ResourceGrade[]
  communityRequests CommunityRequest[]
  bnccSkills        BnccSkill[]

  @@index([educationLevelId])
  @@map("grade")
}

model Subject {
  id     String  @id @default(cuid())
  name   String  @unique
  slug   String  @unique
  isBncc Boolean @default(true)

  grades            GradeSubject[]
  resources         Resource[]
  communityRequests CommunityRequest[]
  bnccSkills        BnccSkill[]

  @@map("subject")
}

model GradeSubject {
  id String @id @default(cuid())

  gradeId   String
  subjectId String

  grade   Grade   @relation(fields: [gradeId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([gradeId, subjectId])
  @@index([gradeId])
  @@index([subjectId])
  @@map("grade_subject")
}

model User {
  id            String   @id @default(cuid())
  name          String
  email         String   @unique
  phone         String?
  emailVerified Boolean  @default(false)
  image         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  role          UserRole @default(user)
  banned        Boolean  @default(false)

  accounts              Account[]
  sessions              Session[]
  subscription          Subscription?
  resourceAccesses      ResourceUserAccess[]
  lessonPlans           LessonPlan[]
  lessonPlanUsage       LessonPlanUsage[]
  communityRequests     CommunityRequest[]
  communityRequestVotes CommunityRequestVote[]
  llmUsageLogs          LlmUsageLog[]

  @@map("user")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId, providerId])
  @@map("account")
}

model Session {
  id                   String   @id @default(cuid())
  expiresAt            DateTime
  token                String   @unique
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  ipAddress            String?
  userAgent            String?
  userId               String
  impersonatedBy       String?
  activeOrganizationId String?
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("session")
}

model Verification {
  id         String    @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@index([identifier])
  @@map("verification")
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String?  @unique
  logo      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  metadata  String?

  @@map("organization")
}

model Subscription {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  isActive     Boolean   @default(true)
  purchaseDate DateTime  @default(now())
  expiresAt    DateTime?

  @@index([userId])
  @@index([isActive])
  @@index([expiresAt])
  @@map("subscription")
}

model ResourceGrade {
  id String @id @default(cuid())

  resourceId String
  gradeId    String

  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  grade    Grade    @relation(fields: [gradeId], references: [id], onDelete: Cascade)

  @@unique([resourceId, gradeId])
  @@index([resourceId])
  @@index([gradeId])
  @@map("resource_grade")
}

model ResourceImage {
  id         String   @id @default(cuid())
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  cloudinaryPublicId String
  url                String?
  alt                String?
  order              Int      @default(0)
  createdAt          DateTime @default(now())

  @@index([resourceId, order])
  @@map("resource_image")
}

model ResourceFile {
  id         String   @id @default(cuid())
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  name               String
  cloudinaryPublicId String
  url                String?
  fileType           String?
  sizeBytes          Int?
  createdAt          DateTime @default(now())

  @@index([resourceId])
  @@map("resource_file")
}

model ResourceVideo {
  id         String   @id @default(cuid())
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  title              String
  cloudinaryPublicId String
  url                String?
  thumbnail          String?
  duration           Int?
  order              Int      @default(0)
  createdAt          DateTime @default(now())

  @@index([resourceId, order])
  @@map("resource_video")
}

model ResourceUserAccess {
  id         String    @id @default(cuid())
  userId     String
  resourceId String
  source     String?
  grantedAt  DateTime  @default(now())
  expiresAt  DateTime?

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([userId, resourceId])
  @@index([userId, resourceId])
  @@map("resource_user_access")
}

model Resource {
  id          String  @id @default(cuid())
  title       String
  description String?

  educationLevelId String
  educationLevel   EducationLevel @relation(fields: [educationLevelId], references: [id])

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id])

  externalId Int?     @unique
  isFree     Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  images        ResourceImage[]
  files         ResourceFile[]
  videos        ResourceVideo[]
  accessEntries ResourceUserAccess[]
  grades        ResourceGrade[]
  bnccSkills    ResourceBnccSkill[]

  originRequestId String?           @unique
  originRequest   CommunityRequest? @relation(fields: [originRequestId], references: [id])

  @@index([educationLevelId])
  @@index([subjectId])
  @@index([title, id])
  @@map("resource")
}

model BnccSkill {
  id String @id @default(cuid())

  code String

  educationLevelId String
  educationLevel   EducationLevel @relation(fields: [educationLevelId], references: [id])

  gradeId String?
  grade   Grade?  @relation(fields: [gradeId], references: [id])

  subjectId String?
  subject   Subject? @relation(fields: [subjectId], references: [id])

  unitTheme             String?
  knowledgeObject       String?
  description           String  @db.Text
  comments              String? @db.Text
  curriculumSuggestions String? @db.Text

  searchVector Unsupported("tsvector")?
  embedding    Unsupported("vector(1536)")?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  resources ResourceBnccSkill[]

  @@unique([code, gradeId], name: "code_gradeId")
  @@index([educationLevelId])
  @@index([gradeId])
  @@index([subjectId])
  @@index([code])
  @@index([searchVector], type: Gin)
  @@map("bncc_skill")
}

model ResourceBnccSkill {
  id String @id @default(cuid())

  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  bnccSkillId String
  bnccSkill   BnccSkill @relation(fields: [bnccSkillId], references: [id], onDelete: Cascade)

  @@unique([resourceId, bnccSkillId])
  @@index([resourceId])
  @@index([bnccSkillId])
  @@map("resource_bncc_skill")
}

model LessonPlan {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title           String
  numberOfClasses Int
  duration        Int

  educationLevelSlug String

  gradeSlug         String?
  subjectSlug       String?
  ageRange          String?
  fieldOfExperience String?

  bnccSkillCodes String[]

  content Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([createdAt])
  @@index([educationLevelSlug])
  @@index([gradeSlug])
  @@index([subjectSlug])
  @@map("lesson_plan")
}

model LessonPlanUsage {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  yearMonth String
  count     Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, yearMonth])
  @@index([userId])
  @@index([yearMonth])
  @@map("lesson_plan_usage")
}

enum CommunityRequestStatus {
  draft
  voting
  selected
  approved
  in_production
  completed
  unfeasible
}

model CommunityRequest {
  id String @id @default(cuid())

  title       String
  description String @db.Text
  votingMonth String

  educationLevelId String
  educationLevel   EducationLevel @relation(fields: [educationLevelId], references: [id])

  gradeId String?
  grade   Grade?  @relation(fields: [gradeId], references: [id])

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  status CommunityRequestStatus @default(draft)

  unfeasibleReason String? @db.Text
  unfeasibleById   String?

  producedResource Resource?

  voteCount      Int @default(0)
  survivedMonths Int @default(0)

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  selectedAt   DateTime?
  completedAt  DateTime?
  unfeasibleAt DateTime?

  votes      CommunityRequestVote[]
  references CommunityRequestReference[]

  @@index([userId])
  @@index([gradeId])
  @@index([educationLevelId])
  @@index([subjectId])
  @@index([status, votingMonth])
  @@map("community_request")
}

model CommunityRequestVote {
  id String @id @default(cuid())

  requestId String
  request   CommunityRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  votingMonth String

  createdAt DateTime @default(now())

  @@unique([requestId, userId])
  @@index([userId, votingMonth])
  @@map("community_request_vote")
}

model CommunityRequestReference {
  id String @id @default(cuid())

  requestId String
  request   CommunityRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  cloudinaryPublicId String
  url                String

  createdAt DateTime @default(now())

  @@index([requestId])
  @@map("community_request_reference")
}

model LlmUsageLog {
  id String @id @default(cuid())

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  feature   String
  operation String

  model    String
  provider String @default("openai")

  inputTokens  Int
  outputTokens Int
  totalTokens  Int

  inputCost  Float
  outputCost Float
  totalCost  Float

  latencyMs Int?

  status       String
  errorMessage String?

  metadata Json?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([feature])
  @@index([createdAt])
  @@index([status])
  @@map("llm_usage_log")
}

model LlmUsageDaily {
  id String @id @default(cuid())

  date    DateTime @db.Date
  feature String
  model   String

  totalCalls   Int
  successCalls Int
  errorCalls   Int

  totalTokens BigInt
  totalCost   Float

  avgLatencyMs Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([date, feature, model])
  @@index([date])
  @@index([feature])
  @@map("llm_usage_daily")
}

model AutomationRule {
  id        String  @id @default(cuid())
  name      String
  eventType String
  isActive  Boolean @default(true)

  conditions Json?

  description String?

  actions AutomationAction[]
  logs    AutomationLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([eventType])
  @@index([isActive])
  @@map("automation_rule")
}

model AutomationAction {
  id     String         @id @default(cuid())
  ruleId String
  rule   AutomationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  type  String
  order Int    @default(0)

  config Json

  createdAt DateTime @default(now())

  logs AutomationLog[]

  @@index([ruleId])
  @@map("automation_action")
}

model AutomationLog {
  id       String            @id @default(cuid())
  ruleId   String
  rule     AutomationRule    @relation(fields: [ruleId], references: [id])
  actionId String?
  action   AutomationAction? @relation(fields: [actionId], references: [id])

  status  String
  payload Json
  error   String?

  executedAt DateTime @default(now())

  @@index([ruleId])
  @@index([actionId])
  @@index([status])
  @@index([executedAt])
  @@map("automation_log")
}

model NotificationTemplate {
  id   String @id @default(cuid())
  slug String @unique
  name String

  type String

  eventType String

  subject String?
  body    String  @db.Text

  description String?
  variables   Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([eventType])
  @@index([isActive])
  @@map("notification_template")
}

// =========================================
// Push Notifications
// =========================================

model PushSubscription {
  id        String   @id @default(cuid())
  endpoint  String   @unique
  p256dh    String
  auth      String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([active])
  @@map("push_subscription")
}

model EmailTemplate {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String // Nome interno para gestão
  subject     String // Assunto do e-mail
  preheader   String? // Texto de apoio que aparece na inbox
  body        String   @db.Text // Conteúdo HTML gerado
  content     Json? // Estrutura JSON do EmailBuilderJS
  eventType   String // Vinculação com o evento do Inngest
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("email_templates")
}

// ============================================
// PUSH CAMPAIGNS (Marketing)
// ============================================

model PushCampaign {
  id       String  @id @default(cuid())
  name     String
  title    String  @db.VarChar(100)
  body     String  @db.VarChar(255)
  url      String?
  icon     String?
  imageUrl String?

  // Segmentação (filtros JSON)
  audience Json @default("{}")

  // Status e agendamento
  status      CampaignStatus @default(DRAFT)
  scheduledAt DateTime?
  sentAt      DateTime?

  // Métricas desnormalizadas
  totalSent    Int @default(0)
  totalClicked Int @default(0)

  // Tracking
  clicks PushCampaignClick[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  @@map("push_campaigns")
}

model PushCampaignClick {
  id         String   @id @default(cuid())
  campaignId String
  userId     String?
  clickedAt  DateTime @default(now())
  userAgent  String?

  campaign PushCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([clickedAt])
  @@map("push_campaign_clicks")
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  FAILED
}

model WhatsAppTemplate {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  body        String   @db.Text
  eventType   String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([eventType])
  @@map("whatsapp_template")
}

model PushTemplate {
  id   String @id @default(cuid())
  slug String @unique
  name String // Nome interno para gestão

  // Conteúdo da notificação
  title String // max 100 chars
  body  String @db.Text // max 500 chars

  // Visual
  icon  String? // /icons/vote.png ou null = padrão
  badge String? // /icons/badge.png ou null = padrão
  image String? // Imagem grande (opcional)

  // Comportamento
  url String? // /community/{{request.id}}
  tag String? // community-vote (agrupa notificações)

  // Metadata
  eventType   String // community.request.voted
  description String? // Descrição interna

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([eventType])
  @@index([isActive])
  @@map("push_template")
}
