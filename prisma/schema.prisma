generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}
datasource db {
  provider = "postgresql"
}

enum UserRole {
  user
  subscriber
  editor
  manager
  admin
}

model EducationLevel {
  id        String     @id @default(cuid())
  name      String     @unique
  slug      String     @unique
  order     Int        @default(0)

  grades  Grade[]
  resources Resource[]
  communityRequests CommunityRequest[]

  @@map("education_level")
}

model Grade {
  id               String         @id @default(cuid())
  name             String
  slug             String         @unique
  order            Int            @default(0)

  educationLevelId String
  educationLevel   EducationLevel @relation(fields: [educationLevelId], references: [id])

  subjects         GradeSubject[]
  
  resources ResourceGrade[]
  communityRequests CommunityRequest[]

  @@index([educationLevelId])
  @@map("grade")
}

model Subject {
  id        String          @id @default(cuid())
  name      String          @unique
  slug      String          @unique

  grades    GradeSubject[]
  resources Resource[]
  communityRequests CommunityRequest[]

  @@map("subject")
}

model GradeSubject {
  id        String  @id @default(cuid())

  gradeId   String
  subjectId String

  grade     Grade   @relation(fields: [gradeId], references: [id], onDelete: Cascade)
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([gradeId, subjectId])
  @@index([gradeId])
  @@index([subjectId])
  @@map("grade_subject")
}

model User {
  id               String     @id @default(cuid())
  name             String
  email            String     @unique
  phone            String?
  emailVerified    Boolean    @default(false)
  image            String?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  role             UserRole   @default(user)  
  banned           Boolean    @default(false)
  
  accounts     Account[]
  sessions     Session[]
  subscription Subscription?
  resourceAccesses ResourceUserAccess[]
  lessonPlans  LessonPlan[]
  lessonPlanUsage LessonPlanUsage[]
  communityRequests      CommunityRequest[]
  communityRequestVotes  CommunityRequestVote[]

  @@map("user")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId, providerId])
  @@map("account")
}

model Session {
  id                   String   @id @default(cuid())
  expiresAt            DateTime
  token                String   @unique
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  ipAddress            String?
  userAgent            String?
  userId               String
  impersonatedBy       String?
  activeOrganizationId String?
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("session")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@index([identifier])
  @@map("verification")
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String? @unique
  logo      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  metadata  String?

  @@map("organization")
}

model Subscription {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  isActive      Boolean  @default(true)
  purchaseDate  DateTime @default(now())
  expiresAt     DateTime? // Calculado automaticamente baseado no plan.durationDays

  @@index([userId])
  @@index([isActive])
  @@index([expiresAt])
  @@map("subscription")
}

model ResourceGrade {
  id         String   @id @default(cuid())

  resourceId String
  gradeId    String

  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  grade      Grade    @relation(fields: [gradeId], references: [id], onDelete: Cascade)

  // evita duplicar o mesmo vínculo
  @@unique([resourceId, gradeId])
  @@index([resourceId])
  @@index([gradeId])

  @@map("resource_grade")
}

model ResourceImage {
  id          String       @id @default(cuid())
  resourceId  String
  resource    Resource  @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  cloudinaryPublicId String
  url         String?
  alt         String?
  order       Int @default(0)
  createdAt   DateTime  @default(now())

  @@index([resourceId, order])
  @@map("resource_image")
}

model ResourceFile {
  id          String       @id @default(cuid())
  resourceId  String
  resource    Resource  @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  name        String
  cloudinaryPublicId String
  fileType    String?
  sizeBytes   Int?
  createdAt   DateTime  @default(now())

  @@index([resourceId])
  @@map("resource_file")
}

model ResourceVideo {
  id          String       @id @default(cuid())
  resourceId  String
  resource    Resource  @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  title       String
  cloudinaryPublicId String
  thumbnail   String?
  duration    Int?
  order       Int @default(0)
  createdAt   DateTime  @default(now())

  @@index([resourceId, order])
  @@map("resource_video")
}

model ResourceUserAccess {
  id         String   @id @default(cuid())
  userId     String
  resourceId String
  source     String?
  grantedAt  DateTime @default(now())
  expiresAt  DateTime?

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([userId, resourceId])
  @@index([userId, resourceId])
  @@map("resource_user_access")
}

model Resource {
  id              String             @id @default(cuid())
  title           String
  description     String?  

  educationLevelId String
  educationLevel   EducationLevel    @relation(fields: [educationLevelId], references: [id])
  
  subjectId        String
  subject          Subject           @relation(fields: [subjectId], references: [id])
  
  externalId      Int             @unique
  isFree          Boolean         @default(false)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  images ResourceImage[]
  files ResourceFile[]
  videos ResourceVideo[]
  accessEntries ResourceUserAccess[]
  grades ResourceGrade[]

  originRequestId String?           @unique
  originRequest   CommunityRequest? @relation(fields: [originRequestId], references: [id])

  @@index([educationLevelId])
  @@index([subjectId])
  @@index([title, id])
  @@map("resource")
}

model BnccSkill {
  id String @id @default(cuid())

  code String // nao pode ser @unique

  educationLevelSlug String

  fieldOfExperience String?
  ageRange String?

  gradeSlug String?
  subjectSlug String?
  unitTheme String?
  knowledgeObject String?

  description String @db.Text
  comments String? @db.Text
  curriculumSuggestions String? @db.Text

  // Full-Text Search (criado automaticamente por trigger - ver reset-db.sh)
  searchVector Unsupported("tsvector")?
  embedding Unsupported("vector(1536)")?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([educationLevelSlug])
  @@index([gradeSlug])
  @@index([subjectSlug])
  @@index([code])
  @@index([searchVector], type: Gin)  

  @@unique([code, gradeSlug], name: "code_gradeSlug")
  @@unique([code, ageRange], name: "code_ageRange")

  @@map("bncc_skill")
}

model LessonPlan {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Identificação do plano
  title           String  // Tema da aula (ex: "Frações básicas e suas representações")
  numberOfClasses Int     // 1, 2 ou 3 aulas
  duration        Int     // Calculado: numberOfClasses * 50 (minutos)

  // Contexto pedagógico (slugs para flexibilidade)
  educationLevelSlug String  // "educacao-infantil", "ensino-fundamental-1", etc

  // Bifurcação EI vs EF
  gradeSlug          String? // EF: "ef1-3-ano", "ef2-6-ano", etc
  subjectSlug        String? // EF: "matematica", "lingua-portuguesa", etc
  ageRange           String? // EI: "4-5-anos", etc
  fieldOfExperience  String? // EI: "O eu, o outro e o nós", etc

  // Habilidades BNCC selecionadas
  bnccSkillCodes String[] // Array de códigos BNCC (ex: ["EF03MA09", "EF03MA10"])

  // Conteúdo completo do plano (JSON estruturado)
  content Json // { identification, bnccSkills, objectives, methodology, resources, evaluation }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([createdAt])
  @@index([educationLevelSlug])
  @@index([gradeSlug])
  @@index([subjectSlug])
  @@map("lesson_plan")
}

model LessonPlanUsage {
  id String @id @default(cuid())

  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  yearMonth String // "YYYY-MM" (ex: "2026-01", "2026-02")
  count     Int    @default(0) // Quantos planos criados nesse mês

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, yearMonth])
  @@index([userId])
  @@index([yearMonth])
  @@map("lesson_plan_usage")
}

enum CommunityRequestStatus {
  draft           // Rascunho (não publicado)
  voting          // Em votação (visível para todos)
  selected        // Selecionado para avaliação de viabilidade
  approved        // Aprovado para produção (viável)
  in_production   // Em produção
  completed       // Produzido e disponível
  unfeasible      // Inviável (desqualificado com justificativa)
}

model CommunityRequest {
  id              String                  @id @default(cuid())
  
  title           String                  
  description     String                  @db.Text
  votingMonth     String                  // Ex: "2026-02"

  // Relações de Categoria
  educationLevelId String
  educationLevel   EducationLevel         @relation(fields: [educationLevelId], references: [id])
  
  gradeId         String?                 // Opcional: para granularidade de ano/série (EF)
  grade           Grade?                  @relation(fields: [gradeId], references: [id])

  subjectId       String
  subject         Subject                @relation(fields: [subjectId], references: [id])

  // Autor
  userId          String
  user            User                    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Controle de Estado
  status          CommunityRequestStatus  @default(draft)
  
  // Feedback Admin
  unfeasibleReason String?                @db.Text
  unfeasibleById   String?
  
  // Resultado
  producedResource Resource?              

  // Contadores denormalizados para performance
  voteCount       Int                     @default(0)
  survivedMonths  Int                     @default(0) // Quantas vezes sobreviveu ao corte mensal (max 3)

  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  selectedAt      DateTime?               // Quando foi selecionado (top 10)
  completedAt     DateTime?               // Quando foi marcado como produzido
  unfeasibleAt    DateTime?               // Para controle de limpeza (30 dias)

  // Relações
  votes           CommunityRequestVote[]
  references      CommunityRequestReference[]

  @@index([userId])
  @@index([gradeId])
  @@index([educationLevelId])
  @@index([subjectId])
  @@index([status, votingMonth])
  @@map("community_request")
}

model CommunityRequestVote {
  id              String            @id @default(cuid())
  
  requestId       String
  request         CommunityRequest  @relation(fields: [requestId], references: [id], onDelete: Cascade)

  userId          String            
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  votingMonth     String            // Formato: "2026-02" - para contar votos do mês

  createdAt       DateTime          @default(now())

  @@unique([requestId, userId])     // Um voto por pessoa por pedido
  @@index([userId, votingMonth])    // Para contar votos usados no mês
  @@map("community_request_vote")
}

model CommunityRequestReference {
  id              String            @id @default(cuid())
  
  requestId       String
  request         CommunityRequest  @relation(fields: [requestId], references: [id], onDelete: Cascade)

  cloudinaryPublicId String
  url             String
  
  createdAt       DateTime          @default(now())

  @@index([requestId])
  @@map("community_request_reference")
}
